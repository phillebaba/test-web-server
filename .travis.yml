sudo: true
language: go
stages:
- test
- name: release
  if: tag IS present
jobs:
  include:
  - stage: test
    script:
    - go get golang.org/x/lint/golint
    - golint
  - script: go test -v
  - stage: release
    env:
    - DOCKER_USERNAME=phillebaba
    - secure: YZ8o/eQoFyL1w3+KN21UFPnNHQ2jtEaGevGnv60XfhK+VRn+zFk9LjCYigCx4Dr8Z/grc5J5Rt7+06fWLwkUK4xBMtQqiD0AofRwco6x2R6UdW/Ub7GZp6Y3SFHhNPmpX9RX3YD86rrebMNvZfzJUbwZ/qzxiUjzHnhD+A7GgaWSgyk98D2j+LPRCDLnZ4c1bISTfwGxoEWKeZqX5a5syeyhtIiOnoPSCt4r18RHnFtNf+2tBKlSz+NehlWD8l7DT4rQxzapoOr+xBb0T+PoH+Qi2jD3wU4od4eNi4c1IgjTi6K83JuQWXB5dWLaTgf8wO5WDeqaEgRVFyL29czltINd1H2RtR3O53IK5G7n2BzZ9wdF57mCmKl1rSHLao0yp0HaJA7OZ46VbZFEG3LbKZoD2Cj5NJHE8IOorj9dDMVr/EUWPhLe8aRbTfsOLqEbaVM8rUqGKqndM45suoMS9AfKyE4oNFkm1/baXR3yUCzcJstl2RjMygpFY8+k57Upg+Swp+Ku931Pb8ZVEffogTgSp1PfnHRySHkmc3okPq20fyTdT4zkU50RzpBsvloK2f/HNxQDeG8DqrTMBcQIYz5wOKBn2uk6p2zEm8TZwmu4YNtKs+gBzulfgQyIiPe9dL1HgYaja2alQTrHr5kHY/VNghLr5LPE1dIpC+DLjrw=
    services: docker
    script:
    - docker run --rm --privileged multiarch/qemu-user-static:register
    - env GOOS=linux GOARCH=amd64 go build -o test-web-server-amd64
    - env GOOS=linux GOARCH=arm go build -o test-web-server-arm
    - env GOOS=linux GOARCH=arm64 go build -o test-web-server-arm64
    - docker build -t $DOCKER_USERNAME/test-web-server:${TRAVIS_TAG}-linux-amd64 -f
      ./Dockerfile.amd64 .
    - docker build -t $DOCKER_USERNAME/test-web-server:${TRAVIS_TAG}-linux-arm -f
      ./Dockerfile.arm .
    - docker build -t $DOCKER_USERNAME/test-web-server:${TRAVIS_TAG}-linux-arm64 -f
      ./Dockerfile.arm64 .
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - docker push $DOCKER_USERNAME/test-web-server:${TRAVIS_TAG}-linux-amd64
    - docker push $DOCKER_USERNAME/test-web-server:${TRAVIS_TAG}-linux-arm
    - docker push $DOCKER_USERNAME/test-web-server:${TRAVIS_TAG}-linux-arm64
    - wget https://github.com/estesp/manifest-tool/releases/download/v0.6.0/manifest-tool-linux-amd64
    - mv manifest-tool-linux-amd64 manifest-tool
    - chmod +x manifest-tool
    - ./manifest-tool push from-args --platforms linux/amd64,linux/arm,linux/arm64
      --template "phillebaba/test-web-server:${TRAVIS_TAG}-OS-ARCH" --target "phillebaba/test-web-server:${TRAVIS_TAG}"
    deploy:
      provider: releases
      skip_cleanup: true
      api_key:
        secure: FVZO66FB/oxF9D5gsrEqgO+ntuRbiY3pL/q1Uz1gc+M35SbXAlZgC/PTo8gStCkG3n+x24XWfdbVPVN5410WjI4WrsHlsQXC0Rcsn5zUjwcINeEvk3CuHuHT+63nifVxpU/ArTos2gHIvnV8tzN0Hu73yt+Ee0kxfCIDnFQlP3FBBJpOyXyqoAKVonTClvboD5Nlwkke6TOCatu7WUqfxZ95xw1sJa1THKjlHt7HKcXLj9L7jqSccL1yy6/OTxuWgejqduYQ2+asnTDlry0GW4axYT8CXTyJ8Jet/O4ce9DcxXi5zuy2s4f8ToFlMLxkICfipJFeqNxhuoCqZzda5648TSvWyGZWDGwifpQff/GpZvhKQooyOz7VHhtzvFyIejF6QUlanBzJDDWXqEPem/gNRH0mforoALUYfka1M59PaKanafX9qN9CtaMrIlIg/nNOT0nLj61eAR62eQ7lJHiqS2DIXCI7Ex3iTkQyMfFMo9C6lP94pUjp0yzHWPdO4WX/Og9/QelugX23g194D96Uiwi/03MYilDHiSHnakO/ZhUgwlMUP5U5cz3j0/opY/9mM9FMb9AAW+cMsEISmFiuEtNhYT1xMLK4iGdmjtBoZGuc6oo6Jb4wVEE0xiRvQ0co2XPY2yMSS/FXPTJbdtYPg+mFQBKEwFWZfmfMs0c=
      file:
      - test-web-server-amd64
      - test-web-server-arm
      - test-web-server-arm64
      on:
        repo: phillebaba/test-web-server
        tags: true
