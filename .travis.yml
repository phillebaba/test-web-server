sudo: true
language: go
stages:
- test
- name: release
  if: tag IS present
jobs:
  include:
  - stage: test
    script:
    - go get golang.org/x/lint/golint
    - golint
  - script: go test -v
  - stage: release
    env:
    - DOCKER_USERNAME=phillebaba
    - secure: HPo+unWL5cst8jXsheLaoAStrzDXSUy6+sUhh8H+u8uKLT6t7KzXaubmxvoaWdcYcklNxGctssGhkjeCV28O9hqKh8DIiypjS7amM9/2Kfku0uyGcFQJOQK/gVtb/MRUkeIGnhMSMzn7zep1V60bl/ygktzK4JTj7I1YiiX31qMuYGkw0HgQD6G6oyTNWmHdAdnKpwg81cUCZMDMpVUffHbxsyA4OqNrie6l8C5QDj3I+AJqhMd5IVXq7+GHlYIwUQcHXWMd24F/jNcfh09OSQ5vhys1VTg14Jibshfrnlw/7nPcDZRQOVYS+fI0l4G7hiXQXP5BiiMyA85fdT7ICLudPEDRZXOuAfbLZ/Eg3ks1XIXWaPAGhfb+dPPjvfqRI70bz2Ijso+HIz9p+M2zGzKO7MSETQ6oyq1iAu2dfJbv+ZWucna7jNZZ7z5GfKr4V6N3iUeR73tmuOWLmlsLdwjkC8YrRRku2x4FZ5Z4+B5u2PWMr2u+xrnMh3C3L5THlKreqI44P1UcHtijy/pEpyiZ+W2IXi1af1TNGw/BpgZU9ZOPW+KM1H7X9/FTTBmQDcEb5820Atk3woKunR4MtehQa2VXJ4B9xuy+QaMxg3SWTKyzQUXP6nx5O/+7bzW9mZSS4vtJSx3sFwenOYfgMxamQknaNmcq218iR6aauiE=
    services: docker
    script:
    - docker run --rm --privileged multiarch/qemu-user-static:register
    - env GOOS=linux GOARCH=amd64 go build -o test-web-server-amd64
    - env GOOS=linux GOARCH=arm go build -o test-web-server-arm
    - env GOOS=linux GOARCH=arm64 go build -o test-web-server-arm64
    - docker build -t $DOCKER_USERNAME/test-web-server:${TRAVIS_TAG}-linux-amd64 -f
      ./Dockerfile.amd64 .
    - docker build -t $DOCKER_USERNAME/test-web-server:${TRAVIS_TAG}-linux-arm -f
      ./Dockerfile.arm .
    - docker build -t $DOCKER_USERNAME/test-web-server:${TRAVIS_TAG}-linux-arm64 -f
      ./Dockerfile.arm64 .
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - docker push $DOCKER_USERNAME/test-web-server:${TRAVIS_TAG}-linux-amd64
    - docker push $DOCKER_USERNAME/test-web-server:${TRAVIS_TAG}-linux-arm
    - docker push $DOCKER_USERNAME/test-web-server:${TRAVIS_TAG}-linux-arm64
    - wget https://github.com/estesp/manifest-tool/releases/download/v0.6.0/manifest-tool-linux-amd64
    - mv manifest-tool-linux-amd64 manifest-tool
    - chmod +x manifest-tool
    - ./manifest-tool push from-args --platforms linux/amd64,linux/arm,linux/arm64
      --template "phillebaba/test-web-server:${TRAVIS_TAG}-OS-ARCH" --target "phillebaba/test-web-server:${TRAVIS_TAG}"
    deploy:
      provider: releases
      skip_cleanup: true
      api_key:
        secure: RT2rkBZlHxNBtPfu4CDS0M7rEr5NQMO7lL9OiTgu8eydI9j6g4jUCGOrsdE1eCdXwqZ7uZicPjREUycLL7g+frZpgP4E5T/ftES9l9Fzj0QrGNUHuP4wXCkQc+LYpu7p7fQMhcBqIcKbd6jKvigEJpeJ69UBuiwupSLon9xxj+FRs7urR5KuugSKgidgWrQykUjCLlFDOtsj98ZIN0F5Pe9aMVdyT74XONdC24qPe5RnLXk0JLJXLZMjHY76Lbh6nRxUYKxdtyyf1rx5UhU7HJCqE8TMHhdLPnWLJjxSEINlhtjb2JiFs+uV+nfuC9F/PW1fSIulZ+uGkc9H1LeBf7L+2ikb9K0dFBrBFgqFG/MP7KslA2OEAR9UAR37J8LzkJCwXfv7h8Om0lOEt8zsrzx0ECfPyOnu7J7aDqrm5jRMu+dgxJNmgqlFDMUjsNY7wUotRKlaxbOtWUpSjR7pthL3WOQsGogJgvPbYU6wI/YwlWK19k/6AmyZuKa8E4jFnKTUI7fx7cdaooV/aEDznh5pkDPAuGvnJJSeEvn5ax/0ncvZKv6mpqJOCYYnMjsMvrQGLV+br5Nfp9vsu4+hMl02ZcM4pKP5/dUz3n8UVJ4QcSGchKt1UGI/8mg8WRbXNG37GpcuM0IhdqQjzmPmY+q9j6KXNVl+mCbdUGRvJC8=
      file:
      - test-web-server-amd64
      - test-web-server-arm
      - test-web-server-arm64
      on:
        repo: phillebaba/test-web-server
        tags: true
